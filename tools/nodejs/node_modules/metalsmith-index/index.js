module.exports = plugin;

const fs = require('fs');

const outFilePath = 'contentIndex.json';

const defaultOptions = {
}

function plugin(options) {
  options = options || [];
  return function (files, metalsmith, done) {
    let fd = fs.openSync(outFilePath, 'w');
    // console.log('write start json')
    fs.write(fd, '{\r\n');
    
    let isFirst = true;
    for (filePath in files) {
      if (!files.hasOwnProperty(filePath)) continue;
      if (!isFirst) {
        //console.log('write sep end prop');
        fs.write(fd, ',\r\n');
      }
        
      isFirst  = false;

      let content = files[filePath];
      // console.log('write key', filePath)
      fs.write(fd, `"${filePath.replace('.html', '.md')}": `)
      
      let indexContent = Object.assign({}, content);
      delete indexContent['contents'];
      delete indexContent['stats'];
      delete indexContent['mode'];
      // console.log('write value')
      fs.write(fd, JSON.stringify(indexContent));
    }
    // console.log('write end json')
    fs.write(fd, '\r\n}\r\n');
    fs.close(fd);

    done();
  };
};
