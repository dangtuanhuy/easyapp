<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Local App</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/datatables.min.css">
    <link rel="stylesheet" href="assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/github.min.css">
    <link rel="stylesheet" href="assets/css/codemirror.min.css">
    <link rel="stylesheet" href="assets/css/simplemde.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <script>
        var saveModule = module;
        delete module;
    </script>
</head>
<body class="container-fluid">
<window-login></window-login>
<landing></landing>
<home></home>
<window-public></window-public>
<!-- preload toàn bộ tag -->
<!--<script src="tag/toolbar.tag" type="riot/tag"></script>-->
<!--<script src="tag/nav.tag" type="riot/tag"></script>-->
<!--<script src="tag/code-editor.tag" type="riot/tag"></script>-->
<!--<script src="tag/form-editor.tag" type="riot/tag"></script>-->
<!--<script src="tag/code-view.tag" type="riot/tag"></script>-->
<!--<script src="tag/new-site.tag" type="riot/tag"></script>-->
<!--<script src="tag/build.tag" type="riot/tag"></script>-->
<!--<script src="tag/landing.tag" type="riot/tag"></script>-->
<!--<script src="tag/review.tag" type="riot/tag"></script>-->
<!--<script src="tag/setting.tag" type="riot/tag"></script>-->
<!--<script src="tag/content.tag" type="riot/tag"></script>-->
<!--<script src="tag/layout.tag" type="riot/tag"></script>-->
<!--<script src="tag/browse.tag" type="riot/tag"></script>-->
<!--<script src="tag/home.tag" type="riot/tag"></script>-->
<!--<script src="tag/home.tag" type="riot/tag"></script>-->
<!--<script src="tag/meta-view.tag" type="riot/tag"></script>-->
<!--<script src="tag/config-view.tag" type="riot/tag"></script>-->
<!--<script src="tag/layout-view.tag" type="riot/tag"></script>-->
<!--<script src="tag/content-view.tag" type="riot/tag"></script>-->
<!--<script src="tag/markdown-editor.tag" type="riot/tag"></script>-->

<script src="tag/form-editor.tag" type="riot/tag"></script>
<script src="tag/markdown-editor.tag" type="riot/tag"></script>

<script src="tag/content-view.tag" type="riot/tag"></script>
<script src="tag/config-view.tag" type="riot/tag"></script>
<script src="tag/layout-view.tag" type="riot/tag"></script>
<script src="tag/breadcrumb.tag" type="riot/tag"></script>
<script src="tag/side-bar.tag" type="riot/tag"></script>
<script src="tag/new-site.tag" type="riot/tag"></script>

<script src="tag/window-login.tag" type="riot/tag"></script>
<script src="tag/window-public.tag" type="riot/tag"></script>
<script src="tag/landing.tag" type="riot/tag"></script>
<script src="tag/home.tag" type="riot/tag"></script>

<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/bootbox.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/datatables.min.js"></script>
<script src="assets/js/highlight.min.js"></script>
<script src="assets/js/jsonlint.min.js"></script>
<script src="assets/js/codemirror.min.js"></script>
<script src="assets/js/simplemde.min.js"></script>
<script src="assets/js/riot+compiler.min.js"></script>
<script>module = saveModule;</script>

<script>
    var BackEnd = require('./assets/js/backend.js');
    window.BackEnd = BackEnd;

    var Path = require('path');
    var Fs = require('fs');
    var ChildProcess = require('child_process');

    var SimpleGit = require('simple-git');
    var BlueBird = require('bluebird');

    var mkdir = BlueBird.promisify(Fs.mkdir);

    var GitBin = Path.join(__dirname, 'tools', 'git', 'bin', 'git');
    var SiteDir = Path.join(__dirname, 'sites');

    var login, landing, home;

    function InitRepository(name) {
        return new BlueBird(function (resolve, reject) {
            var errHandler = function (err) {
                if (err) reject(err);
            };
            SimpleGit(Path.join(SiteDir, name))
                    .customBinary(GitBin)
                    .init(false, errHandler)
                    .add()
                    .commit('init', function (err, ret) {
                        if (err) reject(err);
                        else resolve(ret);
                    });
        });
    }

    function NpmInstall(path) {

    }

    function CloneRepository(repositoryUrl, localPath) {
        return new BlueBird(function (resolve, reject) {
            SimpleGit(Path.join(SiteDir, name))
                    .customBinary(GitBin)
                    .clone(repositoryUrl, localPath, function (err, ret) {
                        if (err) reject(err);
                        else resolve(ret)
                    });
        });
    }

    riot.api = riot.observable();
    Object.assign(riot.api, {
        cloneRepository: CloneRepository,
        openSite:        function (sitePath) {
            console.log('openSite', sitePath);
            landing.unmount();
            home = riot.mount('home', {sitePath: sitePath});
        },

        createSite: function (name) {
            // TODO detect exists name in sitePath
            var localPath = Path.join(__dirname, 'sites', name);
            return mkdir(localPath).then(function () {
                return CloneRepository('https://github.com/easywebhub/easyweb-metalsmith', localPath);
            });
        }
    });

    riot.compile(function () {
        login = riot.mount('window-login');
//        landing = riot.mount('landing');
//        home = riot.mount('home', {siteName: 'aaa'});
    });
</script>
</body>
</html>
