<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>EasyWeb Builder</title>
    <link rel="stylesheet" href="assets/css/jquery-ui.min.css">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/jquery.jspanel.min.css">
    <link rel="stylesheet" href="assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/octicons.min.css">
    <link rel="stylesheet" href="assets/css/editormd.min.css">
    <link rel="stylesheet" href="assets/css/github.min.css">
    <link rel="stylesheet" href="assets/css/codemirror.min.css">
    <link rel="stylesheet" href="assets/css/simplemde.min.css">
    <link rel="stylesheet" href="assets/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="assets/css/bootstrap-datetimepicker.min.css">

    <link rel="stylesheet" href="assets/css/frameworks-355fc5f5dc43030d495ea75b6bc8366695646a7566c13dd6ba2c2d358e1b5383.css">
    <link rel="stylesheet" href="assets/css/site-429acc2fc05149afec2a05196b3100560f117f753931d0afca46da6e1eeafe39.css">

    <link rel="stylesheet" href="assets/css/summernote.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- <link crossorigin="anonymous" href="/assets/css/frameworks-355fc5f5dc43030d495ea75b6bc8366695646a7566c13dd6ba2c2d358e1b5383.css" media="all" rel="stylesheet" /> -->
    <!-- <link crossorigin="anonymous" href="https://assets-cdn.github.com/assets/github-7fae2d802a203f722465a757a5c1ecdb285d355fdcda038c10a2d20722dcf959.css" media="all" rel="stylesheet" /> -->
    <!-- <link crossorigin="anonymous" href="/assets/css/site-429acc2fc05149afec2a05196b3100560f117f753931d0afca46da6e1eeafe39.css" media="all" rel="stylesheet" /> -->
    <script>
        var saveModule = module;
        delete module;
    </script>
</head>

<body>
<window-login></window-login>
<landing></landing>
<home></home>
<window-public></window-public>
<dialog-login-signup></dialog-login-signup>
<!-- preload toàn bộ tag -->
<script src="tag/config-view-array.tag" type="riot/tag"></script>
<script src="tag/config-view-object.tag" type="riot/tag"></script>
<script src="tag/config-view-text.tag" type="riot/tag"></script>
<script src="tag/config-view-media.tag" type="riot/tag"></script>
<script src="tag/config-view-number.tag" type="riot/tag"></script>
<script src="tag/config-view-datetime.tag" type="riot/tag"></script>
<script src="tag/config-view-boolean.tag" type="riot/tag"></script>
<script src="tag/config-view-prop-predefined-value.tag" type="riot/tag"></script>
<script src="tag/form-editor.tag" type="riot/tag"></script>
<script src="tag/markdown-editor.tag" type="riot/tag"></script>
<script src="tag/file-list-flat.tag" type="riot/tag"></script>

<script src="tag/github-init-dialog.tag" type="riot/tag"></script>
<script src="tag/progress-dialog.tag" type="riot/tag"></script>
<script src="tag/new-category-dialog.tag" type="riot/tag"></script>
<script src="tag/new-tag-dialog.tag" type="riot/tag"></script>
<script src="tag/new-content-dialog.tag" type="riot/tag"></script>
<script src="tag/new-layout-dialog.tag" type="riot/tag"></script>
<script src="tag/code-view.tag" type="riot/tag"></script>
<script src="tag/watch-view.tag" type="riot/tag"></script>
<script src="tag/content-view.tag" type="riot/tag"></script>
<script src="tag/meta-view.tag" type="riot/tag"></script>
<script src="tag/config-view.tag" type="riot/tag"></script>
<script src="tag/code-editor.tag" type="riot/tag"></script>
<script src="tag/breadcrumb.tag" type="riot/tag"></script>
<script src="tag/side-bar.tag" type="riot/tag"></script>
<script src="tag/dialog-new-site-local.tag" type="riot/tag"></script>
<script src="tag/dialog-new-site-import.tag" type="riot/tag"></script>
<script src="tag/deploy-ftp-dialog.tag" type="riot/tag"></script>
<script src="tag/dialog-login-signup.tag" type="riot/tag"></script>

<script src="tag/window-login.tag" type="riot/tag"></script>
<script src="tag/window-public.tag" type="riot/tag"></script>
<script src="tag/landing.tag" type="riot/tag"></script>
<script src="tag/home.tag" type="riot/tag"></script>

<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/jquery-ui.min.js"></script>
<script src="assets/js/pouchdb.min.js"></script>
<script src="assets/js/summernote.min.js"></script>
<script src="assets/js/moment.min.js"></script>
<script src="assets/js/bootbox.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/jquery.jspanel-compiled.min.js"></script>
<script src="assets/js/highlight.min.js"></script>
<script src="assets/js/jsonlint.min.js"></script>
<script src="assets/js/codemirror.min.js"></script>
<script src="assets/js/simplemde.min.js"></script>
<script src="assets/js/editormd.min.js"></script>
<script src="assets/js/lib/underscore.min.js"></script>
<script src="assets/js/lib/raphael.min.js"></script>
<script src="assets/js/lib/flowchart.min.js"></script>
<script src="assets/js/lib/sequence-diagram.min.js"></script>
<script src="assets/js/editormd.en.js"></script>
<script src="assets/js/bootstrap-select.min.js"></script>
<script src="assets/js/bootstrap-datetimepicker.min.js"></script>
<script src="assets/js/riot+compiler.min.js"></script>
<script>module = saveModule;</script>

<script>
    var fs = require('fs');
    var BackEnd = require(__dirname + '/assets/js/backend.js');
    var API = require(__dirname + '/assets/js/remote-api.js');
    window.DB = new PouchDB({name: 'DB', size: 1000, revs_limit: 8, adapter: 'websql'});
    DB.upsert = function (doc) {
        return DB.get(doc).then(function (existsDoc) {
            Object.assign(doc, existsDoc);
            return DB.put(existsDoc);
        }).catch(function (err) {
            if (doc._id)
                return DB.put(doc);
            else
                return DB.post(doc);
        });
    };

    window.BackEnd = BackEnd;
    window.API = API;


    window.User = require('./user-test');
    // TO SHOW ALL UNCOMMENT LINE BELLOW
    window.User.accountType = 'dev';

    window.curPage = null;
    var formMixin = {
        edit: function (keyPath, e) {
            var value;
            switch (e.target.type) {
                case 'checkbox':
                    value = e.target.checked;
                    break;
                case 'number':
                    value = parseInt(e.target.value, 10);
                    break;
                default:
                    value = e.target.value;
            }

            var schema = this;
            var pList = keyPath.split('.');
            var len = pList.length;
            for (var i = 0; i < len - 1; i++) {
                var elem = pList[i];
                if (!schema[elem]) schema[elem] = {};
                schema = schema[elem];
            }
            schema[pList[len - 1]] = value;
        }
    };

    riot.mixin('form', formMixin);

    riot.event = riot.observable();
    Object.assign(riot.event, {
        openSite: function (sitePath) {
            if(window.curPage) window.curPage.unmount(true);
            console.log('index.html openSite', sitePath);
            landing.unmount(true);
            window.curPage = riot.mount('home', {sitePath: sitePath})[0];
        },

        createSite: function (name, repoUrl, branch) {
//            var localPath = Path.join(__dirname, 'sites', name);
            name = name.toLowerCase()
                    .normalize('NFKD')
                    .replace(/[\u0300-\u036F]/g, '')
                    .replace(/đ/g, 'd')
                    .replace(/[?,!\/'":;#$@\\()\[\]{}^~]*/g, '')
                    .replace(/\s+/g, '-')
                    .trim();
            return BackEnd.createSiteFolder(name).then(function (sitePath) {
                return BackEnd.gitCheckout(repoUrl, branch, sitePath).then(function () {
                    console.log('git checkout done', name);
                    if (window.curPage) window.curPage.unmount(true);
                    window.curPage = riot.mount('home', {siteName: name})[0];
                }).catch(function (ex) {
                    console.log(ex.message);
                });
            });
        }
    });

    function CheckAccountAndGoToLanding() {
        if (window.curPage) window.curPage.unmount(true);
        DB.get('account').then(function (account) {
            window.User = account;
            console.log('TODO server only accept accountType "user"');
            account.accountType = 'dev';
            console.log('account on disk', account);
            window.curPage = riot.mount('landing')[0];
            // TODO missing api get new site
        }).catch(function (ex) {
            console.log('no account in disk');
            window.curPage = riot.mount('dialog-login-signup')[0];
        });
    }

    riot.compile(function () {
        console.log('check account on disk and go to landing');
//        curPage = riot.mount('window-login')[0];
//        curPage = riot.mount('home', {siteName: 'test1'})[0];
        // uncomment to enable login
//        CheckAccountAndGoToLanding();
        window.curPage = riot.mount('landing')[0];
    });

    riot.event.on('loginSuccess', function (account) {
        console.log('onLoginSuccess, save account to disk', account);
        account['_id'] = 'account';
        DB.upsert(account).then(function (response) {
            CheckAccountAndGoToLanding();
        }).catch(function (err) {
            console.log(err);
        });
    });

    riot.event.on('logout', function (account) {
        DB.get('account').then(doc => {
            DB.remove(doc).then(function () {
                CheckAccountAndGoToLanding();
            });
        }).catch(function (_) {
        });
    });

    riot.event.on('showLandingPage', function () {
        if (window.curPage) window.curPage.unmount(true);
        console.log('showLandingPage');
        window.curPage = riot.mount('landing')[0];
    });

    // check new template.js and write to disk
    var remoteTemplateUrl = 'https://easywebhub.com/website-marketplace.json';
    var checkRemoteTemplate = function () {
        $.ajax({
            method: 'GET',
            url:    remoteTemplateUrl
        }).then(function (newTemplate) {
            try {
                var curTemplate = JSON.parse(fs.readFileSync('template.json').toString());
                if (typeof newTemplate === 'string')
                    newTemplate = JSON.parse(newTemplate);

                if (typeof newTemplate !== 'object') {
                    console.log('new template is not an object, do nothing');
                    return;
                }

                if ((newTemplate.version && curTemplate.version && newTemplate.version > curTemplate.version) || !curTemplate.version) {
                    console.log('save new template.json to disk');
                    fs.writeFileSync('template.json', JSON.stringify(newTemplate, null, 4));
                }
            } catch (ex) {
                console.log('update template failed', ex);
                // write new template file if remote data valid
                if (typeof newTemplate === 'object') {
                    console.log('try write use remote template');
                    fs.writeFileSync('template.json', JSON.stringify(newTemplate, null, 4));
                }
            }
        })
    };
    checkRemoteTemplate();

</script>

<!--<div class="container site-footer-container" style="padding: 0;">-->
<!--<div class="site-footer" role="contentinfo" style="padding-bottom: 0; padding-top: 5px;">-->
<!--&lt;!&ndash; <ul class="site-footer-links right">-->
<!--<li><a href="https://status.github.com/" data-ga-click="Footer, go to status, text:status">Status</a></li>-->
<!--<li><a href="https://developer.github.com" data-ga-click="Footer, go to api, text:api">API</a></li>-->
<!--<li><a href="https://training.github.com" data-ga-click="Footer, go to training, text:training">Training</a></li>-->
<!--<li><a href="https://shop.github.com" data-ga-click="Footer, go to shop, text:shop">Shop</a></li>-->
<!--<li><a href="https://github.com/blog" data-ga-click="Footer, go to blog, text:blog">Blog</a></li>-->
<!--<li><a href="https://github.com/about" data-ga-click="Footer, go to about, text:about">About</a></li>-->
<!--</ul> &ndash;&gt;-->


<!--<ul class="site-footer-links">-->
<!--<li>&copy; 2016 <span title="0.01148s from github-fe126-cp1-prd.iad.github.net">EasyWebHub</span>, Inc.</li>-->
<!--<li><a href="http://easywebhub.com/" data-ga-click="Footer, go to terms, text:terms">Home</a></li>-->
<!--<li><a href="http://book.easywebhub.com/" data-ga-click="Footer, go to privacy, text:privacy">Document</a></li>-->
<!--<li><a href="https://github.com/security" data-ga-click="Footer, go to security, text:security">Security</a></li>-->
<!--</ul>-->
<!--</div>-->
<!--</div>-->

</body>
</html>
